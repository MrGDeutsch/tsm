<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Momentum Radar</title>
  <meta name="description" content="Time series momentum screener (Moskowitz et al., 2012)" />
  <link href="https://cdn.tailwindcss.com" rel="stylesheet" />
  <script>
    tailwind.config = { theme: { extend: { colors: { brand: '#3b82f6' } } } }
  </script>
  <style>
    body { -webkit-font-smoothing: antialiased; }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { to { background-position: 200% 0; } }
  </style>
  <link rel="manifest" href="#" />
  <script>
    const manifest = {
      name: "Momentum Radar",
      short_name: "Momentum",
      start_url: "/",
      display: "standalone",
      background_color: "#ffffff",
      theme_color: "#3b82f6",
      icons: [{ src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìà</text></svg>", sizes: "192x192", type: "image/svg+xml" }]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    document.querySelector('link[rel="manifest"]').href = url;
  </script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-2">Momentum Radar</h1>
    <p class="text-sm text-gray-600 text-center mb-4">
      Time series momentum (Moskowitz et al., 2012)
    </p>

    <input type="text" id="apiKey" placeholder="Enter Finnhub API key (free at finnhub.io)" class="w-full p-2 border rounded mb-2 text-sm" />
    <button id="scanBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded mb-4 transition">
      Scan Now
    </button>

    <div id="status" class="text-xs text-gray-500 text-center mb-2"></div>
    <div id="results" class="space-y-3 mb-6"></div>
    <p class="text-xs text-gray-500 text-center">
      Based on academic time series momentum. Not financial advice.
    </p>
  </div>

  <script>
    // Expanded ticker list: US stocks + ETFs from Trading212 & Revolut (200+)
    const TICKERS = [
      // Mega/Large Cap
      'AAPL', 'MSFT', 'NVDA', 'AMZN', 'GOOGL', 'GOOG', 'META', 'TSLA', 'BRK.B', 'UNH', 'LLY', 'JNJ', 'V', 'PG', 'MA', 'AVGO', 'HD', 'MRK', 'CVX', 'ABBV',
      'PEP', 'COST', 'KO', 'WMT', 'DIS', 'ADBE', 'CRM', 'NFLX', 'AMD', 'INTC', 'QCOM', 'TXN', 'IBM', 'ORCL', 'CSCO', 'PYPL', 'SBUX', 'BA', 'CAT', 'MMM',
      
      // Mid/Small Cap (high momentum potential)
      'SMCI', 'ARM', 'MSTR', 'COIN', 'PLTR', 'RIVN', 'LCID', 'SNAP', 'PINS', 'ROKU', 'DASH', 'UBER', 'LYFT', 'ABNB', 'SHOP', 'ETSY', 'TTD', 'ZS', 'CRWD',
      'NET', 'DDOG', 'OKTA', 'SNOW', 'MDB', 'TEAM', 'NOW', 'WDAY', 'ZM', 'DOCU', 'FSLY', 'PATH', 'GTLB', 'CFLT', 'AFRM', 'UPST', 'SOFI', 'HOOD', 'OPEN',
      'RBLX', 'EXPE', 'MTCH', 'IAC', 'ANGI', 'CHTR', 'TMUS', 'VZ', 'T', 'LUMN', 'DKNG', 'PENN', 'MGM', 'WYNN', 'MAR', 'HLT', 'BKNG', 'ABNB', 'CCL', 'RCL',
      
      // ETFs (broad, sector, thematic)
      'SPY', 'QQQ', 'IWM', 'DIA', 'VTI', 'VOO', 'ARKK', 'XLK', 'XLF', 'XLV', 'XLE', 'XLY', 'XLP', 'XLI', 'XLB', 'XLRE', 'XLU', 'XLC', 'SMH', 'SOXX', 'IBB',
      'KWEB', 'FXI', 'EEM', 'VGK', 'EWJ', 'INDA', 'VNQ', 'GLD', 'SLV', 'USO', 'UNG', 'HYG', 'LQD', 'TLT', 'SHY', 'IEF', 'AGG', 'BND', 'VEA', 'VWO', 'IJR', 'IJH',
      'MTUM', 'QUAL', 'VLUE', 'SIZE', 'USMV', 'SPHD', 'JEPI', 'SCHD', 'VIG', 'DGRO', 'NOBL', 'QYLD', 'XYLD', 'DIVO', 'HDV', 'SPYD', 'IDV', 'VYM',
      
      // Crypto & Micro (Revolut/Trading212 favorites)
      'MSTR', 'COIN', 'IBIT', 'FBTC', 'ARKB', 'BITO',
      
      // International ADRs (available on Revolut)
      'ASML', 'SAP', 'NVO', 'NOVN.SW', 'NESN.SW', 'HSBC', 'UL', 'UN', 'BUD', 'TM', 'SONY', 'HMC', 'NSRGY', 'AZN', 'RHHBY', 'BCH', 'SID', 'VALE', 'PBR',
      'BBL', 'GSK', 'BP', 'TOT', 'ENB', 'CVE', 'SU', 'IMO', 'CNQ', 'ARCC', 'MAIN', 'O', 'STAG', 'GOOD', 'PSEC', 'BX', 'KKR', 'APO', 'CG', 'IVZ', 'BLK', 'TROW'
    ];

    // EWMA volatility (60-day)
    function ewmaVolatility(prices, lambda = 0.983) {
      if (prices.length < 2) return 1;
      const returns = [];
      for (let i = 1; i < prices.length; i++) {
        returns.push((prices[i] - prices[i - 1]) / prices[i - 1]);
      }
      let variance = 0;
      let weightSum = 0;
      for (let i = returns.length - 1; i >= 0; i--) {
        const weight = Math.pow(lambda, returns.length - 1 - i);
        variance += weight * Math.pow(returns[i], 2);
        weightSum += weight;
      }
      return Math.sqrt(variance / weightSum) * Math.sqrt(252);
    }

    async function fetchPrices(ticker, apiKey) {
      const from = Math.floor((Date.now() - 320 * 24 * 60 * 60 * 1000) / 1000);
      const to = Math.floor(Date.now() / 1000);
      const url = `https://finnhub.io/api/v1/stock/candle?symbol=${ticker}&resolution=D&from=${from}&to=${to}&token=${apiKey}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.s !== 'ok' || !data.c || data.c.length < 252) return null;
        return data.c;
      } catch (e) {
        console.warn(`Failed ${ticker}:`, e);
        return null;
      }
    }

    function calculateSignal(prices, ticker) {
      if (!prices || prices.length < 252) return null;
      const p0 = prices[prices.length - 252];
      const p1 = prices[prices.length - 1];
      const ret12M = (p1 / p0) - 1;
      const vol60D = ewmaVolatility(prices.slice(-61));
      return {
        ticker,
        ret12M: (ret12M * 100).toFixed(1),
        vol60D: (vol60D * 100).toFixed(1),
        score: ret12M / (vol60D || 1)
      };
    }

    function renderResults(results, fallback = false) {
      const container = document.getElementById('results');
      if (results.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">No data available. Check API key or network.</p>';
        return;
      }
      const header = fallback 
        ? '<div class="text-center text-orange-600 text-sm mb-2">‚ö†Ô∏è No positive momentum. Showing top performers (may be negative).</div>'
        : '';
      const html = header + results.map(r => `
        <a href="https://finance.yahoo.com/quote/${r.ticker}" target="_blank" rel="noopener"
           class="block p-3 bg-white rounded-lg shadow border ${r.ret12M >= 0 ? 'border-green-200' : 'border-red-200'} hover:bg-blue-50">
          <div class="font-bold text-lg">${r.ticker}</div>
          <div class="text-sm">
            <span class="${r.ret12M >= 0 ? 'text-green-600' : 'text-red-600'}">${r.ret12M >= 0 ? '+' : ''}${r.ret12M}%</span> (12M) ‚Ä¢ Vol: ${r.vol60D}% ‚Ä¢ Score: ${r.score.toFixed(2)}
          </div>
        </a>
      `).join('');
      container.innerHTML = html;
    }

    async function scan() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) {
        alert('Please enter your free Finnhub API key (get one at finnhub.io)');
        return;
      }

      const btn = document.getElementById('scanBtn');
      const statusEl = document.getElementById('status');
      btn.disabled = true;
      btn.textContent = 'Scanning...';
      statusEl.textContent = 'Fetching data...';
      document.getElementById('results').innerHTML = 
        '<div class="skeleton h-16 rounded-lg"></div><div class="skeleton h-16 rounded-lg mt-2"></div>';

      const signals = [];
      let count = 0;
      for (const ticker of TICKERS) {
        count++;
        statusEl.textContent = `Processing ${count}/${TICKERS.length}: ${ticker}`;
        const prices = await fetchPrices(ticker, apiKey);
        const signal = calculateSignal(prices, ticker);
        if (signal) signals.push(signal);
        // Optional: add small delay to avoid rate limits
        await new Promise(r => setTimeout(r, 10));
      }

      // Filter: only positive 12M returns (academic TSM rule)
      const longSignals = signals.filter(s => parseFloat(s.ret12M) > 0);
      let displaySignals = longSignals.length > 0 
        ? longSignals 
        : signals; // fallback if none positive

      displaySignals.sort((a, b) => b.score - a.score);
      renderResults(displaySignals.slice(0, 10), longSignals.length === 0);

      localStorage.setItem('momentumResults', JSON.stringify(displaySignals));
      localStorage.setItem('lastScan', Date.now());

      btn.disabled = false;
      btn.textContent = 'Scan Again';
      statusEl.textContent = '';
    }

    window.addEventListener('load', () => {
      const cached = localStorage.getItem('momentumResults');
      if (cached) {
        renderResults(JSON.parse(cached));
      }
    });

    document.getElementById('scanBtn').addEventListener('click', scan);
  </script>
</body>
</html>